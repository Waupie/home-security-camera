html name=templates/index.html
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pi Camera Live</title>
    <style>
      body { background:#111; color:#eee; font-family: sans-serif; text-align:center; }
      img { max-width: 100%; height: auto; border: 4px solid #222; margin-top: 20px; }
      .container { width: 90%; max-width: 900px; margin: 0 auto; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Pi Camera Live Stream</h1>
      <p>Stream URL: <code>/stream</code></p>
      <!-- Primary MJPEG display: browsers that support MJPEG in <img> will show the live stream here -->
      <img id="mjpeg" src="/stream" alt="Live stream">

      <!-- Fallback: some clients handle MJPEG better when loaded in an <iframe> or <object>. -->
      <iframe id="mjpeg_iframe" src="/stream" style="display:none;border:0;width:100%;height:540px;" title="MJPEG fallback"></iframe>

      <p id="status" style="margin-top:12px;color:#bbb">Status: waiting for stream...</p>

      <div style="margin-top:16px;">
        <button id="recordBtn">Record 10s</button>
        <span id="recordStatus" style="margin-left:12px;color:#f55"></span>
      </div>

      <div id="recordingLink" style="margin-top:12px;"></div>

      <script>
        // Small compatibility helper: keep the <img> primary, but show iframe fallback on error.
        (function(){
          const img = document.getElementById('mjpeg');
          const iframe = document.getElementById('mjpeg_iframe');
          const status = document.getElementById('status');

          function showStreaming() {
            status.textContent = 'Status: streaming';
            img.style.display = '';
            iframe.style.display = 'none';
          }

          function showFallback() {
            status.textContent = 'Status: image failed â€” using iframe fallback';
            img.style.display = 'none';
            iframe.style.display = 'block';
          }

          // If the image loads a first frame, mark streaming.
          img.addEventListener('load', function(){ showStreaming(); });

          // If the image element errors, switch to the iframe fallback.
          img.addEventListener('error', function(){ showFallback(); });

          // As a small safety, if nothing happens after a few seconds, try the fallback.
          setTimeout(function(){
            // If the image hasn't changed from the placeholder and iframe is still hidden, try fallback.
            if (img.complete === false) {
              showFallback();
            }
          }, 4000);
        })();

        // Recording UI
        (function(){
          const btn = document.getElementById('recordBtn');
          const status = document.getElementById('recordStatus');
          const linkBox = document.getElementById('recordingLink');

          async function startRecord(){
            status.textContent = 'Starting...';
            btn.disabled = true;
            linkBox.innerHTML = '';
            try{
              const resp = await fetch('/record', { method: 'POST' });
              if (!resp.ok) throw new Error('busy');
              const data = await resp.json();
              status.textContent = `Recording ${data.duration}s...`;
              // wait duration + small buffer then fetch last_recording
              setTimeout(async ()=>{
                status.textContent = 'Finalizing...';
                const r = await fetch('/last_recording');
                const j = await r.json();
                if (j.filename){
                  const a = document.createElement('a');
                  a.href = '/recordings/' + encodeURIComponent(j.filename);
                  a.textContent = 'Download: ' + j.filename;
                  linkBox.appendChild(a);
                  status.textContent = 'Recording ready';
                } else {
                  status.textContent = 'No recording found';
                }
                btn.disabled = false;
              }, (10 + 1) * 1000);
            }catch(e){
              status.textContent = 'Recorder busy';
              btn.disabled = false;
            }
          }

          btn.addEventListener('click', startRecord);
        })();
      </script>
    </div>
  </body>
</html>
